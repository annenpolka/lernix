# Lernix: 問題生成・提供フロー設計

## 概要

Lernixはターミナルベースの学習システムで、LLMを活用して様々なカテゴリの問題を生成します。本ドキュメントでは問題の生成から提供までのフローを定義します。

## エンドツーエンドフロー

```mermaid
flowchart TD
    A[学習リクエスト] --> B{キャッシュチェック}
    B -->|ヒット| C[キャッシュから問題取得]
    B -->|ミス| D[問題生成プロセス起動]
    D --> E[プロンプト構築]
    E --> F[LLM API呼び出し]
    F --> G[応答解析と構造検証]
    G --> H{検証通過?}
    H -->|失敗| I[フォールバック処理]
    I --> D
    H -->|成功| J[問題の質的検証]
    J --> K[類似問題検出]
    K --> L[問題フィルタリング]
    L --> M[永続化]
    C --> N[問題の提供]
    M --> N
    N --> O[ユーザー回答]
    O --> P[フィードバック収集]
    P --> Q[問題品質の分析]
    Q --> R[プロンプト改善]
    R --> D
```

## 1. 問題生成フロー

```mermaid
flowchart LR
    A[生成リクエスト] --> B[リクエスト分析]
    B --> C[生成戦略決定]
    C --> D[プロンプト構築]
    D --> E[LLMアダプター選択]
    E --> F[LLM呼び出し]
    F --> G[応答受信]
    G --> H[JSON抽出]
    H --> I[構造的検証]
    I --> J[問題の標準化]
    J --> K[生成結果]

    subgraph プロンプト構成要素
    D1[カテゴリ情報] --> D
    D2[難易度設定] --> D
    D3[生成量] --> D
    D4[除外ID] --> D
    D5[フィードバック反映] --> D
    end
```

## 2. 問題検証フロー

```mermaid
flowchart TB
    A[生成された問題] --> B[基本構造検証]
    B --> C{構造OK?}
    C -->|No| D[問題を破棄]
    C -->|Yes| E[並行検証処理]
    
    E --> F[LLM品質検証]
    E --> G[類似問題検出]
    
    F --> H[品質スコア計算]
    H --> I{品質基準達成?}
    I -->|No| J[問題を破棄]
    I -->|改善可能| K[自動修正]
    I -->|Yes| L[品質OK]
    
    G --> M{類似度チェック}
    M -->|高類似度| N[問題を破棄]
    M -->|中類似度| O[メタデータフラグ付け]
    M -->|低類似度| P[類似OK]
    
    K --> Q[検証済み問題プール]
    L --> Q
    O --> Q
    P --> Q
```

## 3. 類似問題検出フロー

```mermaid
flowchart LR
    A[新規生成問題] --> B{ベクトル埋め込み可能?}
    B -->|Yes| C[問題文のベクトル化]
    C --> D[既存問題ベクトルとの比較]
    D --> E[類似度計算]
    
    B -->|No| F[テキストベース比較]
    F --> G[Jaccard類似度計算]
    
    E --> H[類似度マッピング]
    G --> H
    
    H --> I{類似度閾値}
    I -->|>0.85| J[高類似度:除外]
    I -->|>0.7| K[中類似度:フラグ付け]
    I -->|<0.7| L[低類似度:許容]
```

## 4. フォールバックメカニズム

```mermaid
flowchart TD
    A[生成失敗] --> B[階層的フォールバック]
    B --> C[別LLMプロバイダー試行]
    C -->|成功| D[成功:結果返却]
    C -->|失敗| E[プロンプト簡素化]
    E -->|成功| D
    E -->|失敗| F[キャッシュから類似カテゴリ問題]
    F -->|成功| D
    F -->|失敗| G[緊急問題セット使用]
    G --> D
```

## 実装優先度

1. **P0 (必須)**
   - 基本的な問題生成と構造検証
   - 単純なJSONパースとエラーハンドリング
   - 最小限のフォールバック機能

2. **P1 (重要)**
   - 問題キャッシュ管理
   - 基本的な品質チェック
   - シンプルな類似度検証

3. **P2 (付加価値)**
   - LLMによる高度な品質検証
   - 学習履歴を考慮した問題選択
   - ベクトル埋め込みによる類似度検出

4. **P3 (最適化)**
   - 非同期バッチ生成
   - 高度なプロンプト最適化
   - ユーザー特性に基づく適応

## 実装上の考慮点

- **モジュラー設計**: 各検証ステップは独立して実装・拡張可能
- **段階的実装**: 基本機能から始め、徐々に高度な機能を追加
- **コスト効率**: LLM呼び出しはバッチ処理と必要に応じた検証で最適化
- **ユーザー体験**: ユーザー待機時間を最小化するための非同期処理

Lernixの問題生成フローは知識提供の核心部分であり、このフローの質がアプリケーション全体の価値を決定します。基本的な生成と検証から始め、ユーザーフィードバックに基づいて継続的に改良していくことが重要です。
