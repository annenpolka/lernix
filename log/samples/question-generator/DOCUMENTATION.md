# Lernix Question Generator 実装状況ドキュメント

## 1. 概要

Lernix Question Generator は、LLM（大規模言語モデル）を活用して様々なカテゴリと難易度の問題を自動生成するサンプルアプリケーションです。このコンポーネントは Lernix の中核機能として問題生成フローを担当し、ドメイン駆動設計（DDD）と関数型プログラミングの原則に基づいて実装されています。

## 2. 現在の実装状況

### 2.1 アーキテクチャ

プロジェクトはクリーンアーキテクチャに基づいた明確な関心の分離を実現しています：

- **ドメイン層**: ビジネスロジックとドメインモデル

  - `domain/models`: エンティティと値オブジェクト
  - `domain/services`: ドメインサービス

- **インフラストラクチャ層**: 外部システムとの連携

  - `infrastructure/llm`: LLM プロバイダーとの連携
  - `infrastructure/prompt`: プロンプト構築と管理
  - `infrastructure/cache`: キャッシュ管理

- **アプリケーション層**: アプリケーションフロー
  - `cli.ts`: コマンドラインインターフェース

### 2.2 主要機能

現在実装されている主要機能：

1. **複数カテゴリの問題生成**

   - 数学、科学、歴史、言語、プログラミング、一般知識

2. **様々な難易度レベル**

   - 簡単、普通、難しい、専門家

3. **複数の言語サポート**

   - 日本語、英語、フランス語、ドイツ語、スペイン語、中国語、韓国語

4. **複数 LLM プロバイダー対応**

   - **OpenAI モデル**: o3-mini, gpt-3.5-turbo, o3, gpt-4o, gpt-4.5
   - **Google Gemini モデル**: gemini-1.5-pro, gemini-2.0-flash, gemini-2.0-pro

5. **キャッシュ機能**

   - インメモリキャッシュによる問題の再利用
   - キャッシュ統計の提供

6. **問題の検証とフィルタリング**

   - 基本的な検証ロジックの実装
   - カスタム検証関数の追加サポート
   - 品質スコアと改善提案の型定義

7. **CLI 対話インターフェース**
   - ユーザーフレンドリーな対話式インターフェース
   - ヘッドレス実行モード（E2E テスト用）

### 2.3 実装詳細

#### ドメインモデル

- **Question（問題エンティティ）**:

  - 識別子、カテゴリ、難易度、問題文、選択肢、解説などの属性
  - 問題の作成日時と追加メタデータのサポート

- **Choice（選択肢の値オブジェクト）**:

  - ID、テキスト、正解フラグなどの属性

- **ValidationResult（検証結果の値オブジェクト）**:

  - 有効性フラグ、エラーリスト、品質スコア、類似性スコア、改善必要フラグ

- **列挙型**:
  - カテゴリ、難易度、言語などの型安全な列挙

#### サービス

- **QuestionGenerationService**:
  - LLM からの問題生成ロジック
  - キャッシュ活用による効率化
  - 問題検証機能と品質フィルタリング
  - カスタム検証関数のサポート

#### インフラストラクチャ

- **LLMAdapter**:

  - 抽象インターフェースによる複数 LLM プロバイダー対応
  - OpenAIAdapter: OpenAI API との連携実装
  - GeminiAdapter: Google Gemini API との連携実装

- **PromptBuilder**:

  - ビルダーパターンによるプロンプト構築
  - 複数 LLM に対応した特化型プロンプト設計
  - 言語リソースの国際化対応

- **CacheManager**:
  - インメモリキャッシュ実装（NodeCache 使用）
  - TTL ベースのキャッシュ管理
  - 統計情報の提供

#### CLI

- **cli.ts**:
  - 対話形式の問題生成インターフェース
  - コマンドライン引数のサポート
  - 環境変数とユーザー入力の柔軟な処理
  - 複数 LLM プロバイダー選択機能

### 2.4 テスト実装

- **単体テスト**:

  - LLMAdapter のテスト
  - QuestionGenerationService のテスト
  - モックとスタブを活用した依存性の分離

- **インテグレーションテスト**:
  - OpenAI API との実際の連携テスト
  - Gemini API との連携テスト
  - 低品質問題のフィルタリングテスト

## 3. 技術スタック

- **言語**: TypeScript
- **パッケージ管理**: npm
- **テスト**: Vitest
- **外部ライブラリ**:
  - inquirer: 対話型 CLI の実装
  - commander: コマンドライン引数の処理
  - chalk: ターミナル出力のスタイリング
  - node-cache: インメモリキャッシュ
  - dotenv: 環境変数の管理
  - @google/generative-ai: Google Gemini API 連携

## 4. 設計原則の適用

### 4.1 ドメイン駆動設計（DDD）

- **ユビキタス言語**: 問題、選択肢、カテゴリなどの共通言語の確立
- **バウンデッドコンテキスト**: 問題生成という明確なコンテキストの設定
- **エンティティと値オブジェクト**: 問題（エンティティ）と選択肢（値オブジェクト）の区別
- **集約**: 問題を中心とした整合性単位の設定

### 4.2 関数型プログラミング

- **純粋関数**: 副作用を最小限に抑えた関数設計
- **不変性**: オブジェクトの不変性の重視
- **型安全性**: TypeScript の型システムの活用

### 4.3 テスト駆動開発（TDD）

- テストファーストのアプローチ
- モックを活用した依存関係の分離
- 高いテストカバレッジ

## 5. 現在の制限と課題

1. **LLM プロバイダーの拡張**:

   - 現時点では OpenAI と Google Gemini をサポート
   - Anthropic や Mistral AI など他のプロバイダー追加の余地あり

2. **キャッシュの永続化**:

   - 現在はインメモリキャッシュのみ
   - ファイルまたはデータベースベースの永続キャッシュが必要

3. **問題の品質評価**:

   - 基本的な検証は実装済み
   - 現在は問題文の存在、選択肢数、解説の有無のみをチェック
   - より高度な品質評価メカニズムの実装が必要
   - 型定義には品質スコア（qualityScore）が用意されているが実装は未完成

4. **類似問題検出**:

   - 現在の実装では類似問題の検出機能がない
   - 型定義には類似性スコア（similarityScore）が用意されているが実装は未完成
   - ベクトル埋め込みを活用した類似性検出の実装が有効

5. **パフォーマンス最適化**:
   - バッチ処理や並列処理による最適化の余地

## 6. 拡張ポイント

今後の拡張可能性として特に注目すべき点：

1. **新しい LLM プロバイダーの追加**:

   - Anthropic Claude
   - Mistral AI
   - Llama 3

2. **永続的なキャッシュ実装**:

   - ファイルベースキャッシュ
   - SQLite や PostgreSQL との連携

3. **問題品質評価の強化**:

   - LLM による自己評価機能
   - 数値化された品質スコアの実装
   - 教育専門家による評価基準の実装
   - 問題の難易度適正評価

4. **ベクトルデータベースとの連携**:

   - 類似問題検出のための埋め込み実装
   - Pinecone や Milvus などのベクトル DB との連携

5. **Lernix TUI との統合**:
   - Ink ライブラリを使用した TUI の実装
   - ユーザー体験の向上

## 7. 結論

Lernix Question Generator は、DDD、関数型プログラミング、TDD の原則に基づいて設計・実装された堅牢なサンプルアプリケーションです。OpenAI に加えて Google Gemini もサポートするようになり、複数の LLM プロバイダーに対応した柔軟な設計が実現されています。

問題品質の検証機能は基本的な実装にとどまっていますが、将来的な拡張性を考慮した型定義や設計が整備されています。特に ValidationResult 型には品質スコアや類似性スコアのフィールドが用意されており、今後の品質評価機能強化の基盤が整っています。

キャッシュ機能や複数言語サポートなど、実用的な機能も既に組み込まれており、Lernix プロジェクト全体における問題生成の中核コンポーネントとして機能する準備が整っています。今後の Lernix TUI 実装と組み合わせることで、完全なユーザー体験を提供することが可能になります。
