# Lernix Question Generator 実装状況ドキュメント

## 1. 概要

Lernix Question Generatorは、LLM（大規模言語モデル）を活用して様々なカテゴリと難易度の問題を自動生成するサンプルアプリケーションです。このコンポーネントはLernixの中核機能として問題生成フローを担当し、ドメイン駆動設計（DDD）と関数型プログラミングの原則に基づいて実装されています。

## 2. 現在の実装状況

### 2.1 アーキテクチャ

プロジェクトはクリーンアーキテクチャに基づいた明確な関心の分離を実現しています：

- **ドメイン層**: ビジネスロジックとドメインモデル
  - `domain/models`: エンティティと値オブジェクト
  - `domain/services`: ドメインサービス

- **インフラストラクチャ層**: 外部システムとの連携
  - `infrastructure/llm`: LLMプロバイダーとの連携
  - `infrastructure/cache`: キャッシュ管理

- **アプリケーション層**: アプリケーションフロー
  - `cli.ts`: コマンドラインインターフェース

### 2.2 主要機能

現在実装されている主要機能：

1. **複数カテゴリの問題生成**
   - 数学、科学、歴史、言語、プログラミング、一般知識

2. **様々な難易度レベル**
   - 簡単、普通、難しい、専門家

3. **複数の言語サポート**
   - 日本語、英語、フランス語、ドイツ語、スペイン語、中国語、韓国語

4. **OpenAIモデル対応**
   - o3-mini, gpt-3.5-turbo, o3, gpt-4o, gpt-4.5

5. **キャッシュ機能**
   - インメモリキャッシュによる問題の再利用
   - キャッシュ統計の提供

6. **問題の検証とフィルタリング**
   - 基本的な検証ロジックの実装
   - カスタム検証関数の追加サポート

7. **CLI対話インターフェース**
   - ユーザーフレンドリーな対話式インターフェース
   - ヘッドレス実行モード（E2Eテスト用）

### 2.3 実装詳細

#### ドメインモデル

- **Question（問題エンティティ）**:
  - 識別子、カテゴリ、難易度、問題文、選択肢、解説などの属性
  - 問題の作成日時と追加メタデータのサポート

- **Choice（選択肢の値オブジェクト）**:
  - ID、テキスト、正解フラグなどの属性

- **列挙型**:
  - カテゴリ、難易度、言語などの型安全な列挙

#### サービス

- **QuestionGenerationService**:
  - LLMからの問題生成ロジック
  - キャッシュ活用による効率化
  - 問題検証機能

#### インフラストラクチャ

- **LLMAdapter**:
  - OpenAIモデルとの統一インターフェース
  - プロンプト構築ロジック
  - エラーハンドリング

- **CacheManager**:
  - インメモリキャッシュ実装（NodeCache使用）
  - TTLベースのキャッシュ管理
  - 統計情報の提供

#### CLI

- **cli.ts**:
  - 対話形式の問題生成インターフェース
  - コマンドライン引数のサポート
  - 環境変数とユーザー入力の柔軟な処理

### 2.4 テスト実装

- **単体テスト**:
  - LLMAdapterのテスト
  - QuestionGenerationServiceのテスト
  - モックとスタブを活用した依存性の分離

- **インテグレーションテスト**:
  - OpenAI APIとの実際の連携テスト

## 3. 技術スタック

- **言語**: TypeScript
- **パッケージ管理**: npm
- **テスト**: Vitest
- **外部ライブラリ**:
  - inquirer: 対話型CLIの実装
  - commander: コマンドライン引数の処理
  - chalk: ターミナル出力のスタイリング
  - node-cache: インメモリキャッシュ
  - dotenv: 環境変数の管理

## 4. 設計原則の適用

### 4.1 ドメイン駆動設計（DDD）

- **ユビキタス言語**: 問題、選択肢、カテゴリなどの共通言語の確立
- **バウンデッドコンテキスト**: 問題生成という明確なコンテキストの設定
- **エンティティと値オブジェクト**: 問題（エンティティ）と選択肢（値オブジェクト）の区別
- **集約**: 問題を中心とした整合性単位の設定

### 4.2 関数型プログラミング

- **純粋関数**: 副作用を最小限に抑えた関数設計
- **不変性**: オブジェクトの不変性の重視
- **型安全性**: TypeScriptの型システムの活用

### 4.3 テスト駆動開発（TDD）

- テストファーストのアプローチ
- モックを活用した依存関係の分離
- 高いテストカバレッジ

## 5. 現在の制限と課題

1. **LLMプロバイダーの制限**:
   - 現時点ではOpenAIのみをサポート
   - Anthropic, Geminiなどの他のプロバイダー追加の余地あり

2. **キャッシュの永続化**:
   - 現在はインメモリキャッシュのみ
   - ファイルまたはデータベースベースの永続キャッシュが必要

3. **問題の品質評価**:
   - 基本的な検証のみ実装
   - より高度な品質評価メカニズムの導入が望ましい

4. **類似問題検出**:
   - 現在の実装では類似問題の検出機能がない
   - ベクトル埋め込みを活用した類似性検出の実装が有効

5. **パフォーマンス最適化**:
   - バッチ処理や並列処理による最適化の余地

## 6. 拡張ポイント

今後の拡張可能性として特に注目すべき点：

1. **新しいLLMプロバイダーの追加**:
   - Anthropic Claude
   - Google Gemini
   - Mistral AI
   - Llama 3

2. **永続的なキャッシュ実装**:
   - ファイルベースキャッシュ
   - SQLiteやPostgreSQLとの連携

3. **問題品質評価の強化**:
   - LLMによる自己評価機能
   - 教育専門家による評価基準の実装

4. **ベクトルデータベースとの連携**:
   - 類似問題検出のための埋め込み実装
   - PineconeやMilvusなどのベクトルDBとの連携

5. **Lernix TUIとの統合**:
   - Inkライブラリを使用したTUIの実装
   - ユーザー体験の向上

## 7. 結論

Lernix Question Generatorは、DDD、関数型プログラミング、TDDの原則に基づいて設計・実装された堅牢なサンプルアプリケーションです。現時点では基本的な問題生成機能を実装しており、将来的な拡張性を考慮した設計となっています。

キャッシュ機能や複数言語サポートなど、実用的な機能も既に組み込まれており、Lernixプロジェクト全体における問題生成の中核コンポーネントとして機能する準備が整っています。今後のLernix TUI実装と組み合わせることで、完全なユーザー体験を提供することが可能になります。